name: Deploy to Lightsail

on:
  workflow_run:
    workflows: ['Docker Publish']
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    if: >
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main') ||
      github.event_name == 'workflow_dispatch'

    name: Deploy to AWS Lightsail
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy compose file to Lightsail
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          source: 'compose.prod.yaml'
          target: '/home/ubuntu/leetcode-insights'

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            set -e

            APP_DIR=~/leetcode-insights
            mkdir -p $APP_DIR
            cd $APP_DIR

            echo "ðŸ“¦ Pulling latest images..."
            docker compose -f compose.prod.yaml pull

            echo "ðŸš€ Updating containers..."
            docker compose -f compose.prod.yaml up -d --remove-orphans

            echo "ðŸ§¹ Cleaning unused images..."
            docker image prune -f

            echo "âœ… Deployment completed"
